# opensearch-values.yaml

# 이미지 설정
image:
  tag: "2.19.0"

# 클러스터 이름
clusterName: "opensearch-cluster"
nodeGroup: "master"

# Single 노드 설정
replicas: 1
singleNode: true
minimumMasterNodes: 1

# Java 힙 메모리 설정
opensearchJavaOpts: "-Xmx1g -Xms1g"

# 리소스 설정
resources:
  requests:
    cpu: "1000m"
    memory: "2Gi"
  limits:
    cpu: "2000m"
    memory: "2Gi"

# 영구 볼륨 설정
persistence:
  enabled: true
  size: 10Gi
  storageClass: "standard"

# Secret을 통한 인증서 마운트
secretMounts:
  - name: opensearch-certs
    secretName: opensearch-certs
    path: /usr/share/opensearch/config
    defaultMode: 0644

# 보안 설정
config:
  opensearch.yml: |
    cluster.name: opensearch-cluster
    network.host: 0.0.0.0
    
    # Security 플러그인 SSL 설정
    plugins.security.ssl.transport.pemcert_filepath: esnode.pem
    plugins.security.ssl.transport.pemkey_filepath: esnode-key.pem
    plugins.security.ssl.transport.pemtrustedcas_filepath: root-ca.pem
    plugins.security.ssl.transport.enforce_hostname_verification: false
    
    plugins.security.ssl.http.enabled: true
    plugins.security.ssl.http.pemcert_filepath: esnode.pem
    plugins.security.ssl.http.pemkey_filepath: esnode-key.pem
    plugins.security.ssl.http.pemtrustedcas_filepath: root-ca.pem
    
    # 데모 인증서 사용 허용
    plugins.security.allow_unsafe_democertificates: true
    plugins.security.allow_default_init_securityindex: true
    
    # Admin DN 설정 (kirk 인증서 사용)
    plugins.security.authcz.admin_dn:
      - CN=kirk,OU=client,O=client,L=test,C=de
    
    # Node 인증서 설정
    plugins.security.nodes_dn:
      - 'CN=*.example.com,OU=SSL,O=Test,L=Test,C=DE'
      - 'CN=node.example.com,OU=SSL,O=Test,L=Test,C=DE'
      - 'CN=localhost,OU=SSL,O=Test,L=Test,C=DE'
    
    # 감사 로그 설정
    plugins.security.audit.type: internal_opensearch
    plugins.security.enable_snapshot_restore_privilege: true
    plugins.security.check_snapshot_restore_write_privileges: true
    
    # REST API 역할 설정
    plugins.security.restapi.roles_enabled: ["all_access", "security_rest_api_access"]
    
    # 시스템 인덱스 설정
    plugins.security.system_indices.enabled: true
    plugins.security.system_indices.indices: [
      ".plugins-ml-model",
      ".plugins-ml-task",
      ".opendistro-alerting-config",
      ".opendistro-alerting-alert*",
      ".opendistro-anomaly-results*",
      ".opendistro-anomaly-detector*",
      ".opendistro-anomaly-checkpoints",
      ".opendistro-anomaly-detection-state",
      ".opendistro-reports-*",
      ".opensearch-notifications-*",
      ".opensearch-notebooks",
      ".opensearch-observability",
      ".ql-datasources",
      ".opendistro-asynchronous-search-response*",
      ".replication-metadata-store",
      ".opensearch-knn-models"
    ]

# sysctl 초기화 컨테이너 활성화
sysctlInitContainer:
  enabled: true

# 환경 변수 설정
extraEnvs:
  - name: DISABLE_SECURITY_PLUGIN
    value: "false"

# 서비스 설정
service:
  type: ClusterIP
  annotations: {}
