# otel-collector-config.yaml
receivers:
  # 1. Filelog Receiver: /app/logs/*.log 파일에서 로그를 읽습니다.
  filelog:
    include: [/app/logs/*.log]
    start_at: beginning # 로그 파일 시작부터 읽기
    poll_interval: 1s
    operators:
      # 로그 행을 구조화 (timestamp, level, message 추출)
      - type: regex
        regex: '^(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3})\s+([A-Z]+)\s+\[.+\]\s+([A-Za-z0-9.]+) - (Received log for tenant ([a-zA-Z0-9]+): (.+))$'
        output: extract_fields
        timestamp:
          layout: '%Y-%m-%d %H:%M:%S.%L'
          parse_from: regex_capture.1
        severity:
          parse_from: regex_capture.2
        # 추출된 필드: tenantId (regex_capture.5), message (regex_capture.6)
        
      # 추출된 tenantId를 Resource Attributes로 승격하여 라우팅에 사용
      - type: move
        from: regex_capture.5
        to: resource["tenant.id"]

exporters:
  # 2. OpenSearch Exporter: OpenSearch 클러스터로 로그를 보냅니다.
  opensearch:
    endpoints: ["https://opensearch-cluster-master:9200"] # OpenSearch Service Endpoint
    username: logs_writer # 로그 쓰기 전용 사용자
    password: NewP@ssw0rd123! # 로그 쓰기 전용 비밀번호
    # TLS 검증 비활성화 (Minikube Self-Signed 인증서 사용 시 필수)
    tls:
      insecure: true 
    
processors:
  # 3. Attributes Processor: 라우팅에 사용된 tenant.id를 로그 레코드에 포함
  resource:
    attributes:
      - key: tenant.id
        from_attribute: resource.tenant.id
        action: upsert
        
  # 4. Routing Processor: tenant.id 값에 따라 다른 인덱스로 보냅니다.
  routing:
    attribute: tenant.id
    # logs_writer 역할에 CREATE_INDEX 권한이 있으므로 인덱스가 없으면 생성됩니다.
    default: app-logs-default
    routes:
      - value: tenantA
        # logs_writer 역할은 app-logs-tenant-* 에 대한 쓰기 권한이 있습니다.
        expression: 'app-logs-tenant-a'
      - value: tenantB
        expression: 'app-logs-tenant-b'
        
service:
  pipelines:
    logs:
      receivers: [filelog]
      processors: [resource, routing] # 라우팅 프로세서 사용
      exporters: [opensearch]
